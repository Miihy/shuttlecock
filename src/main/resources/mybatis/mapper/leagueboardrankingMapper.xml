<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fp.shuttlecock.leagueboard.LeagueboardRankingMapper">

<select id="getLeagueRanking" 
        parameterType="com.fp.shuttlecock.leagueboard.PageRequestDTO"
        resultType="com.fp.shuttlecock.leagueboard.LeagueRankDTO" >
        <bind name="start" value="(pageNum-1)*amount" />
    SELECT r.userId, SUM(r.wincount) AS wincount, SUM(r.losecount) AS losecount, u.username, u.badgeId
    FROM leagueRank r, user u
    <![CDATA[WHERE r.userId = u.userId AND r.insertdate > #{startDate} AND r.insertdate < #{endDate}]]>
    GROUP BY r.userId
    ORDER BY (sum(r.wincount) - sum(r.losecount)) DESC
    LIMIT #{start}, #{amount}
<!--     CALL leagueProc('2024-01-01', '2024-03-31', 'u'); -->

</select>

<select id="countLeagueUser"
		parameterType="com.fp.shuttlecock.leagueboard.PageRequestDTO"
		resultType="int">
	SELECT COUNT(DISTINCT r.userId)
	FROM leagueRank r, user u
	<where>
	<![CDATA[r.userId = u.userId AND r.insertdate > '2024-01-01' AND r.insertdate < '2024-03-31']]>
		<if test="searchKeyword != null and searchKeyword != ''">
				AND u.username LIKE CONCAT ('%', #{searchKeyword}, '%')
		</if>
	</where>
</select>


<select id="getLeagueRankingByUsername"
		parameterType="com.fp.shuttlecock.leagueboard.PageRequestDTO"
		resultType="com.fp.shuttlecock.leagueboard.LeagueRankDTO" >
		<bind name="start" value="(pageNum-1)*amount" />
  	 	SELECT r.userId, SUM(r.wincount) AS wincount, SUM(r.losecount) AS losecount, u.username, u.badgeId
   	 	FROM leagueRank r, user u
		<where>
			<![CDATA[
			r.userId = u.userId AND r.insertdate > '2024-01-01' AND r.insertdate < '2024-03-31'
			]]>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND u.username LIKE CONCAT ('%', #{searchKeyword}, '%')
			</if>
		</where>
		GROUP BY userId
		ORDER BY (sum(r.wincount) - sum(r.losecount)) DESC
		LIMIT #{start}, #{amount}

</select>




</mapper>